<html>
  <head>
    <title>TransOver Extension Options</title>
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/options.js"></script>
    <script type="text/javascript" src="lib/tooltip.js"></script>
    <style type="text/css">
      body {
        margin: 10px auto;
        width: 800px;
      }
      body, table {
        color: #4f4f4f;
        font: normal normal normal 14px Verdana, Tahoma, sans-serif;
        border-spacing: 0px;
      }

      input, button {
        font-size: 14px;
      }

      select {
        font-size: 16px;
      }

      td {
        width: 140px;
      }

      div.content {
        text-align: left;
      }

      div.heading {
        text-align: left;
        font-size: 1.3em;
      }

      .option {
        margin-top: 25px;
      }

      fieldset.option {
        border-width: 1px;
        border-radius: 5px;
        border-style: solid;
        border-color: #ccc;
      }

      div.button {
        float: left;
      }

      div.button_group {
        margin-top: 30px;
      }

      #status {
        display: none;
        color: green;
        float: left;
        margin-top: 4px;
        margin-left: 8px;
      }

      .hint {
        color: blue;
      }

      .help {
        cursor: help;
        border-bottom: 1px dotted;
      }

      .disabled {
        color: #ccc;
      }
    </style>
  </head>
  <script type="text/javascript">

    var Langs = [
      ['af', 'Afrikaans'],
      ['sq', 'Albanian'],
      ['ar', 'Arabic'],
      ['hy', 'Armenian'],
      ['az', 'Azerbaijani'],
      ['eu', 'Basque'],
      ['be', 'Belarusian'],
      ['bn', 'Bengali'],
      ['bg', 'Bulgarian'],
      ['ca', 'Catalan'],
      ['zh-CN', 'Chinese (Simplified)'],
      ['zh-TW', 'Chinese (Traditional)'],
      ['hr', 'Croatian'],
      ['cs', 'Czech'],
      ['da', 'Danish'],
      ['nl', 'Dutch'],  
      ['en', 'English'],
      ['et', 'Estonian'],
      ['tl', 'Filipino'],
      ['fi', 'Finnish'],
      ['fr', 'French'],
      ['gl', 'Galician'],
      ['ka', 'Georgian'],
      ['de', 'German'],
      ['el', 'Greek'],
      ['gu', 'Gujarati'],
      ['ht', 'Haitian (Creole)'],
      ['iw', 'Hebrew'],
      ['hi', 'Hindi'],
      ['hu', 'Hungarian'],
      ['is', 'Icelandic'],
      ['id', 'Indonesian'],
      ['ga', 'Irish'],
      ['it', 'Italian'],
      ['ja', 'Japanese'],
      ['kn', 'Kannada'],
      ['ko', 'Korean'],
      ['la', 'Latin'],
      ['lv', 'Latvian'],
      ['lt', 'Lithuanian'],
      ['mk', 'Macedonian'],
      ['ms', 'Malay'],
      ['mt', 'Maltese'],
      ['no', 'Norwegian'],
      ['fa', 'Persian'],
      ['pl', 'Polish'],
      ['pt', 'Portuguese'],
      ['ro', 'Romanian'],
      ['ru', 'Russian'],
      ['sr', 'Serbian'],
      ['sk', 'Slovak'],
      ['sl', 'Slovenian'],
      ['es', 'Spanish'],
      ['sw', 'Swahili'],
      ['sv', 'Swedish'],
      ['ta', 'Tamil'],
      ['te', 'Telugu'],
      ['th', 'Thai'],
      ['tr', 'Turkish'],
      ['uk', 'Ukrainian'],
      ['ur', 'Urdu'],
      ['vi', 'Vietnamese'],
      ['cy', 'Welsh'],
      ['yi', 'Yiddish']
    ];

    function save_options() {
      function get_except_urls() {
        var except_urls = [];
        except_urls = $('input:text', $('#exc_urls_table')).filter(function() {
          return this.value;
        }).map(function() {
          return this.value;
        }).get();

        return except_urls;
      }

      Options.except_urls(get_except_urls());
      Options.target_lang($('#target_lang').val());
      Options.source_lang($('#source_lang').val());
      Options.reverse_lang($('#reverse_lang').val());
      Options.alt_only($('#alt_only:checked').val() ? 1 : 0);
      Options.tts($('#tts:checked').val() ? 1 : 0);
      Options.translate_by($('#translate_by').val());
      Options.delay($('#delay').val());

      $('#status').fadeIn().delay(3000).fadeOut();
    }

    function populate_except_urls() {
      function add_exc_url(url) {
        var input = $('<input type="text">').attr('size', 100).val(url),
            button,
            rm_callback = function() { $(this).closest('tr').fadeOut('fast', function() {$(this).remove()}) };

        if (url) {
          button = $('<button>', {text: 'X'}).click(rm_callback);
        }
        else {
          button = $('<button>', {text: "+"}).click(function() {
            if ($('input:text', $(this).closest('tr') ).val() > '') {
              $(this).text('X').unbind('click').click(rm_callback);
              add_exc_url();
            }
          });
        }
        $('<td>')
          .append(input)
          .after($('<td>').append(button))
          .appendTo($('<tr>', {css: {display: 'none'}}).fadeIn())
          .parent()
          .appendTo($('#exc_urls_table'));
      }

      var saved_except_urls = Options.except_urls();

      saved_except_urls.forEach(function(url) {
        add_exc_url(url);
      });
      add_exc_url();
    }

    function populate_except_langs() {
      var saved_except_langs = Options.except_langs();

      Langs.forEach(function(lang, i) {
        var inp = $('<input id="ex'+lang[0]+'" type="checkbox" value="'+lang[0]+'"/>');
        if (saved_except_langs.some(function(lang_code) { return lang_code == lang[0] }))  {
          inp.attr('checked', true);
        }

        if (i % 5 == 0) {
          $('#exc_lang_table').append('<tr></tr>');
        }
        $('tr:last', $('#exc_lang_table'))
          .append($('<td></td>')
            .append('<label for="ex'+lang[0]+'">'+lang[1]+'</label>')
            .append(inp)
          );
      });

      $('#except_langs').append($('#exc_lang_table'));
    }

    function fill_target_lang() {
      var saved_target_lang = Options.target_lang();

      if (!saved_target_lang) {
        $('#target_lang').append('<option selected value="">Choose...</option>').append('<optgroup label="----------"></optgroup>');
      }

      Langs.forEach(function(lang, i) {
        $('#target_lang').append('<option value="'+lang[0]+'"'+(saved_target_lang == lang[0] ? ' selected' : '')+'>'+lang[1]+'</option>');
      });
    }

    function fill_source_lang() {
      var saved_source_lang = Options.source_lang();
      var help_baloon = new Tooltip();
      var help = '\
                 <b>Autodetect from page locale</b> is a very accurate one. Except it totally fails \
                 <br/>\
                 when locale does not match page language (e.g, russian version of french website).\
                 <br/>\
                 <br/>\
                 <b>Autodetect from word</b> being translated is not as accurate.\
                 <br/>\
                 It may decide for instance that "bonjour" is english word and would therefor\
                 <br/>\
                 show single word translation as opposed to full french version.\
                 <br/>\
                 Also, for that reason, Text-To-Speech is a lot less useful.\
                 <br/>\
                 Also, "reverse translate" option is not available in this mode.\
                 <br/>\
                 Still, it mostly works and does so everywhere.\
                 <br/>\
                 <br/>\
                 <b>Locking to specific language</b> will make it so that every word you translate\
                 <br/>\
                 will be treated as being in that language. 100% accuracy, but only for that language.\
                 <br/>\
                 <br/>\
                 All in all, no best option. Experiment till you find the one that suits you best.\
                 ';

      $('#source_lang').parent().find('.help').hover(function(e) {
          help_baloon.show(e.clientX, e.clientY, help);
      }, function() {
          help_baloon.hide();
      });

      // Reverse lang is only possible (or makes sense) if source language is defined from page locale
      $('#source_lang').change(function() {
        var mode = $(this).val() != 'autodetected_from_locale';
        $('#reverse_lang').attr('disabled', mode);
      });

      $('#source_lang')
        .append('<option value="autodetected_from_locale">Autodetect (page locale)</option>')
        .append('<option value="autodetected_from_word">Autodetect (word)</option>')
        .append('<optgroup label="----------"></optgroup>');

      Langs.forEach(function(lang, i) {
        $('#source_lang').append('<option value="'+lang[0]+'">'+lang[1]+'</option>');
      });

      $('#source_lang').val(saved_source_lang).trigger('change');
    }

    function fill_reverse_lang() {
      var saved_reverse_lang = Options.reverse_lang();
      var target_lang = Options.target_lang();

      $('#reverse_lang').append('<option selected value="">Choose...</option>').append('<optgroup label="----------"></optgroup>');

      Langs.forEach(function(lang, i) {
        if (target_lang == lang[0]) { return }
        $('#reverse_lang').append('<option value="'+lang[0]+'"'+(saved_reverse_lang == lang[0] ? ' selected' : '')+'>'+lang[1]+'</option>');
      });
    }

    $(function() {
      fill_target_lang();
      fill_source_lang();
      fill_reverse_lang();
      populate_except_urls();

      if (Options.translate_by() == 'point') { 
        $('#delay').attr('disabled', false).parent().removeClass('disabled');
      }

      if (Options.alt_only()) {
        $('#delay').attr('disabled', true).parent().addClass('disabled');
      }

      $('#translate_by').val(Options.translate_by()).change(function() {
        if ($(this).val() == 'point' && !$('#alt_only').attr('checked')) {
          $('#delay').attr('disabled', false).parent().removeClass('disabled');
        }
        else {
          $('#delay').attr('disabled', true).parent().addClass('disabled');
        }
      });

      $('#alt_only').attr('checked', Options.alt_only() ? true : false).click(function() {
        if ($('#translate_by').val() == 'point' && !$(this).attr('checked')) {
          $('#delay').attr('disabled', false).parent().removeClass('disabled');
        }
        else {
          $('#delay').attr('disabled', true).parent().addClass('disabled');
        }
      });

      $('#delay').val(Options.delay());

      $('#tts').attr('checked', Options.tts() ? true : false);

      $('#save_button').click(function() { save_options() });
      $('#more_options_link').on('click', function() {
          $('#more_options_link').hide();
          $('#more_options').fadeIn();
      })
    });

  </script>

  <body>
    <div class="content">
      <div class="heading">TransOver options</div>
      <div class="option">
        <label for="target_lang">Translate into</label>
        <select id="target_lang"></select>
        <label for="translate_by">when I</label>
        <select id="translate_by" name="translate_by">
          <option value="click">click on word</option>
          <option value="point">point at word</option>
        </select>
      </div>

      <div class="option" id="more_options_link">
        <a href="#">more options</a>&nbsp;&gt;
      </div>

      <div id="more_options" style="display:none">
        <div class="option">
          <label for="source_lang">Translate from</label>
          <select id="source_lang"></select>
          <span class="hint help"> what?</span>
        </div>

        <div class="option">
          <label for="reverse_lang">Reverse translate to</label>
          <select id="reverse_lang"></select>
          <span class="hint"> (from your language)</span>
        </div>

        <div class="option">
          <label for="alt_only">Only show translation when I hold the 'alt' key</label>
          <input type="checkbox" id="alt_only" name="alt_only"/>
        </div>

        <div class="option">
          <label for="tts">Enable Text-To-Speech</label>
          <input type="checkbox" id="tts" name="tts"/>
          <span class="hint"> (press Ctrl while popup is showing)</span>
        </div>
  
        <div class="option disabled">
          <label for="delay">Wait for</label>
          <input type="number" id="delay" name="delay" disabled/>
          <span>ms before showing translation</span>
        </div>
    
        <div class="option">Don't translate words on these sites:</div>
        <table id='exc_urls_table'></table>
      </div>

      <div class="button_group">
        <div class="button">
          <button id="save_button">Save</button>
        </div>
        <div id="status">Saved! Reload pages for changes to take effect.</div>
        <div style="clear: both"></div>
      </div>
    </div>
  </body>
</html>
