<html>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript" src="lib/jquery-1.5.1.min.js"></script>
  <script type="text/javascript" src="lib/options.js"></script>

  <script type="text/javascript">
    google.load('language', 1);

    var SourceLang = (function() {
      var source_lang = '',
          pos_translations = {};

      return {
        setup: function(lang) {
          console.log('setup lang: ' + lang);

          if (!lang) { return }

          source_lang = lang;

          pos_translations[lang] = pos_translations[lang] || {};

          ['noun', 'adverb', 'verb', 'adjective', 'pronoun', 'preposition', 'conjunction', 'interjection', 'abbreviation'].forEach(function(pos) {
            if (!pos_translations[lang][pos]) {
              translate(pos, function(data) { pos_translations[lang][pos] = data instanceof Array ? data.shift() : data; });
            }
          });
        },
        get: function() {
          return source_lang;
        },
        pos_translations: function(lang) {
          var sl = lang || this.get();
          return pos_translations[sl] || {};
        }
      };
    })();

    function translate(word, onresponse) {
      $.ajax({
          url: "http://www.google.com/translate_a/t",
          dataType: 'json',
          data: {
            client: 'ig',
            text: word,
            sl: Options.source_lang(),
            tl: Options.target_lang(),
            ie: 'UTF8',
            oe: 'UTF8'
          },
          success: onresponse,
          error: function() {
            sendResponse({translation: "Oops.. Dictionary error."});
          }
      });
    }

    chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
      switch (request.handler) {
        case 'set_encoding':
          console.log('setting encoding: '+ request.encoding);
          //Options.encoding(request.encoding);
          sendResponse({});
          break;
        case 'get_options':
          sendResponse({options: {
            except_urls: Options.except_urls(),
            target_lang: Options.target_lang(),
            source_lang: Options.source_lang(),
            delay: Options.delay(),
            shift_only: Options.shift_only()
          }});
          break;
        case 'translate':
          console.log("received to translate: " + request.word);

          translate(
            request.word,
            function (data) {
              var output = [];

              if (data instanceof Array) {
                if (!( data[data.length - 1] instanceof Array )) {
                  var translation = data.shift();
                  output.push(translation);

                  // anything left in data is autodetected language
                  SourceLang.setup(data.shift() || Options.source_lang());
                }
                else  {
                  var translation = data.pop();
                  translation.forEach(function(translation) {
                    var part_of_speech = translation.shift();

                    var trs = translation.slice(0,5);
                    output.push('<b>'+(SourceLang.pos_translations()[part_of_speech] || part_of_speech)+'</b>'+(part_of_speech == "" ? '' : ': ')+trs.join(', '));
                  });

                  // second element in data, if present, is autodetected language
                  SourceLang.setup(data.length == 2 ? data.pop() : Options.source_lang());
                }
              }
              else {
                // this is to ensure previous SourceLang setup has no effect
                SourceLang.setup(Options.source_lang());
                output.push(data);
              }

              var result = output.join('<br/>').toLowerCase();
              sendResponse({translation: result == request.word.toLowerCase() ? 'Oops.. No translation found.' : result, source_lang: SourceLang.get()});
            }
          );
          break;
        case 'bulk_translate':
          console.log("received to bulk translate: " + request.text);

          google.language.translate(request.text, Options.source_lang() == 'autodetect' ? '' : Options.source_lang(), Options.target_lang(), function(result) {
            if (!result.error) {
              var res = result.translation.toLowerCase();
              sendResponse({translation: res == request.text.toLowerCase() ? 'Oops.. No translation found.' : res, source_lang: result.detectedSourceLanguage || Options.source_lang()});
            }
            else {
              sendResponse({translation: "Oops.. Translation error."});
            }
          });
          break;
        default:
          console.log("Error! Unknown handler");
          sendResponse({});
      }
    });
  </script>
</html>
