<html>
  <script type="text/javascript" src="lib/jquery-1.6.1.js"></script>
  <script type="text/javascript" src="lib/xregexp-min.js"></script>
  <script type="text/javascript" src="lib/xregexp-unicode-base.js"></script>
  <script type="text/javascript" src="lib/xregexp-unicode-categories.js"></script>
  <script type="text/javascript" src="lib/underscore.js"></script>
  <script type="text/javascript" src="lib/options.js"></script>

  <script type="text/javascript">
    function translate(word, onresponse) {
      $.ajax({
          url: "http://www.google.com/translate_a/t",
          dataType: 'json',
          data: {
            client: 'ig',
            text: word,
            sl: 'autodetect',
            tl: Options.target_lang(),
            ie: 'UTF8',
            oe: 'UTF8'
          },
          success: onresponse,
          error: function(xrh, status, e) {
            console.log(e);
          }
      });
    }

    chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {

      // Sometimes (e.g. french->russian) Google API returns translation in capitals
      function normalizeCase(text) {
        function is_all_upper_case(t) {
          return XRegExp('^[\\p{Lu} ]+$').test(t);
        };

        if (text instanceof Array) {
          if (_.all(text, is_all_upper_case)) {
            return _.map(text, function(t) { return t.toLowerCase() });
          }
        }
        else {
          if (is_all_upper_case(text)) {
            return text.toLowerCase();
          }
        }
        return text;
      };

      function notTranslated(text, result) {
        //Google API may return original word if failed to translate
        return result.match(new RegExp('^('+text+')?$', 'i'));
      };

      var no_translation_found = 'Oops.. No translation found.';

      switch (request.handler) {
        case 'set_encoding':
          console.log('setting encoding: '+ request.encoding);
          //Options.encoding(request.encoding);
          sendResponse({});
          break;
        case 'get_options':
          sendResponse({
            options: JSON.stringify({
              except_urls: Options.except_urls(),
              target_lang: Options.target_lang(),
              delay: Options.delay(),
              shift_only: Options.shift_only(),
              by_click: Options.by_click()
            })
          });
          break;
        case 'translate':
          console.log("received to translate: " + request.word);

          translate(
            request.word,
            function (data) {
              var output, source_lang;

              //If all goes well, Google API returns something like this:
              // ['book', 'ru', [['noun', 'book', 'blah blah', 'lorem'], ['verb', 'to book', 'to blah blah', 'lorem']]]
              if (data[data.length - 1] instanceof Array) {
                output = [];
                var translation = data.pop();
                translation.forEach(function(t) {
                  var part_of_speech = t.shift();
                  output.push({pos: part_of_speech, meanings: normalizeCase(t)});
                });
                source_lang = data.pop();
              }
              // Google dictionary API falls back to Google translate API if unsuccessful. Hence we receive something like this:
              // ['book', 'ru']
              else  {
                var translation = normalizeCase(data.shift());

                output = notTranslated(request.word, translation) ? no_translation_found : translation;
                source_lang = data.shift();
              }

              sendResponse({translation: JSON.stringify(output), source_lang: source_lang});
            }
          );
          break;
        default:
          console.log("Error! Unknown handler");
          sendResponse({});
      }
    });

  </script>
</html>
