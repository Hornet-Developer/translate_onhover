<html>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript" src="lib/jquery-1.4.2.min.js"></script>

  <script type="text/javascript">
    var pos_translations = {};

    google.load('language', 1);

    function translate(word, onresponse) {
      $.getJSON("http://www.google.com/translate_a/t",
        {
          client: 'ig',
          text: word,
          sl: localStorage['to_source_lang'],
          tl: localStorage['to_target_lang'],
          ie: 'UTF8',
          oe: 'UTF8'
        },
        onresponse
      );
    }

    chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
      switch (request.handler) {
        case 'detect_lang':
          if (request.content) { //for some reason detect_lang gets called 3 times, 1 as expected and 2 others with empty content. This 'if' is a workaround. TODO investigate
            google.language.detect(request.content, function(result) {
              if (!result.error) {
                console.log("bg: detected lang: "+result.language);

                pos_translations[result.language] = pos_translations[result.language] || {};

                ['noun', 'adverb', 'verb', 'adjective', 'pronoun', 'preposition', 'conjunction', 'interjection', 'abbreviation'].forEach(function(pos) {
                  if (!pos_translations[result.language][pos]) {
                    translate(pos, function(data) { pos_translations[result.language][pos] = data instanceof Array ? data.shift() : data; });
                  }
                });

                localStorage['to_source_lang'] = result.language;
              }
            });
          }

          sendResponse({});
          break;
        case 'set_encoding':
          console.log('bg: setting encoding: '+ request.encoding);
          localStorage['to_encoding'] = request.encoding;
          sendResponse({});
          break;
        case 'translate':
          console.log("bg: received to translate: " + request.word);

          translate(
            request.word,
            function (data) {
              var output = [];

              if (data instanceof Array) {
                data.pop().forEach(function(translation) {
                  var part_of_speech = translation.shift();

                  var trs = translation.slice(0,5);
                  output.push('<b>'+(pos_translations[localStorage['to_source_lang']][part_of_speech] || part_of_speech)+'</b>'+(part_of_speech == "" ? '' : ': ')+trs.join(', '));
                });
              }
              else {
                output = [data];
              }

              sendResponse({translation: output.join('<br/>')});
            }
          );
          break;
        default:
          console.log("bg: Error! Unknown handler");
          sendResponse({});
      }
    });
  </script>
</html>
